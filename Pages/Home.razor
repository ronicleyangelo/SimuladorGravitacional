@page "/"
@inject ProgramacaoAvancada.Services.SimuladorService Simulacao
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>🌌 Simulador Gravitacional 2D</PageTitle>

<div class="sim-container @(Simulacao.Rodando ? "simulacao-ativa" : "")">
    <!-- Área principal da simulação -->
    <div class="simulation-area">
        <div class="canvas-wrap">
            <svg @ref="svgElement" width="@Simulacao.CanvasWidth" height="@Simulacao.CanvasHeight"
                style="background-color: transparent;">
                @foreach (var corpo in Simulacao.Corpos)
                {
                    <circle cx="@corpo.PosX.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                        cy="@corpo.PosY.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                        r="@corpo.Raio.ToString(System.Globalization.CultureInfo.InvariantCulture)" fill="@corpo.Cor"
                        opacity="0.9" filter="url(#glow)" />
                }

                <text x="10" y="20" fill="#a0a0ff" font-size="12px">
                    Corpos: @Simulacao.Corpos.Count | Iterações: @Simulacao.Iteracoes | Colisões: @Simulacao.Colisoes
                </text>

                <!-- Efeito de glow para os corpos -->
                <defs>
                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur" />
                        <feMerge>
                            <feMergeNode in="coloredBlur" />
                            <feMergeNode in="SourceGraphic" />
                        </feMerge>
                    </filter>
                </defs>
            </svg>
        </div>

        <!-- Estatísticas em tempo real - VISÍVEIS EM TELA CHEIA -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-value">@Simulacao.Corpos.Count</span>
                <span class="stat-label">Corpos</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">@Simulacao.Iteracoes</span>
                <span class="stat-label">Iterações</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">@Simulacao.Colisoes</span>
                <span class="stat-label">Colisões</span>
            </div>
            <div class="stat-item">
                <span class="stat-value status-indicator @(Simulacao.Rodando ? "status-ativa" : "status-pausada")">
                    @(Simulacao.Rodando ? "● Ativa" : "● Pausada")
                </span>
                <span class="stat-label">Status</span>
            </div>
        </div>
    </div>

    <!-- Painel lateral moderno -->
    <div class="side-panel">
        <div class="panel-header">
            <h1>🌌 Simulador Gravitacional</h1>
            <p>Controle a simulação em tempo real</p>
        </div>

        <div class="controls-container">
            <!-- Controles na parte superior -->
            <div class="controls">
                <div class="control-group">
                    <label for="numCorpos">🎯 Quantidade de Corpos</label>
                    <input type="number" id="numCorpos" @bind="Simulacao.NumCorpos" @bind:event="oninput"
                        min="1" max="50" class="num-input" />
                    <small style="color: #a0a0ff; font-size: 0.8rem;">
                        @(Simulacao.Corpos.Count != Simulacao.NumCorpos ? "Clique em Iniciar para aplicar" : "Quantidade aplicada")
                    </small>
                </div>

                <!-- Grupo de botões principais -->
                <div class="button-group">
                    <button @onclick="Iniciar" disabled="@Simulacao.Rodando" class="btn btn-start">
                        <span>▶️</span> Iniciar
                    </button>
                    <button @onclick="Parar" disabled="@(!Simulacao.Rodando)" class="btn btn-stop">
                        <span>⏸️</span> Parar
                    </button>
                    <button @onclick="Resetar" class="btn btn-reset">
                        <span>🔄</span> Resetar
                    </button>
                    <button @onclick="Salvar" class="btn btn-save">
                        <span>💾</span> Salvar TXT
                    </button>
                    <label class="btn btn-load">
                        <span>📂</span> Carregar TXT
                        <InputFile OnChange="OnFileUpload" accept=".txt" hidden />
                    </label>
                </div>

                <!-- Grupo de botões do banco de dados -->
                <div class="button-group database-buttons">
                    <button @onclick="SalvarNoBanco" class="btn btn-db-save">
                        <span>💾</span> Salvar no Banco
                    </button>
                    <button @onclick="ToggleGerenciarUniversos" class="btn btn-db-manage">
                        <span>🌌</span> Gerenciar Universos
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(mensagem))
            {
                <div class="mensagem">@mensagem</div>
            }

            <!-- Modal para gerenciar universos -->
            @if (mostrarGerenciador)
            {
                <div class="modal-overlay" @onclick="ToggleGerenciarUniversos">
                    <div class="modal-content" @onclick:stopPropagation>
                        <div class="modal-header">
                            <h3>🌌 Gerenciar Universos Salvos</h3>
                            <button @onclick="ToggleGerenciarUniversos" class="btn-close">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="modal-controls">
                                <button @onclick="CarregarListaUniversos" class="btn btn-refresh">
                                    <span>🔄</span> Atualizar Lista
                                </button>
                                <button @onclick="CriarNovoUniverso" class="btn btn-new-universe">
                                    <span>🌟</span> Novo Universo
                                </button>
                            </div>

                            @if (universosSalvos.Any())
                            {
                                <div class="universos-list">
                                    @foreach (var universo in universosSalvos)
                                    {
                                        <div class="universo-item">
                                            <div class="universo-info">
                                                <strong>@universo.Nome</strong>
                                                <small>Corpos: @universo.CorposNavigation.Count | 
                                                       Criado: @universo.DataCriacao.ToString("dd/MM HH:mm")</small>
                                            </div>
                                            <div class="universo-actions">
                                                <button @onclick="() => CarregarUniverso(universo.Id)" 
                                                        class="btn btn-sm btn-load-universe">
                                                    🚀 Carregar
                                                </button>
                                                <button @onclick="() => AtualizarUniverso(universo.Id)" 
                                                        class="btn btn-sm btn-update-universe">
                                                    ✏️ Atualizar
                                                </button>
                                                <button @onclick="() => DeletarUniverso(universo.Id)" 
                                                        class="btn btn-sm btn-delete-universe">
                                                    🗑️ Deletar
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="no-universos">
                                    <p>Nenhum universo salvo no banco de dados.</p>
                                    <p style="font-size: 0.9rem; opacity: 0.7;">
                                        Salve sua simulação atual clicando em "Salvar no Banco"
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Event-log ocupando o restante do espaço -->
            <div class="event-log">
                <h3>📜 Log de Eventos</h3>
                <div class="event-list">
                    @if (Simulacao.Eventos.Any())
                    {
                        @foreach (var evento in Simulacao.Eventos)
                        {
                            <div class="event-item">@evento</div>
                        }
                    }
                    else
                    {
                        <div class="event-item" style="text-align: center; opacity: 0.7; font-style: italic;">
                            ⏳ Aguardando eventos da simulação...
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ElementReference svgElement;
    private System.Timers.Timer? loop;
    private string mensagem = string.Empty;
    private const double deltaTime = 0.016;
    
    // Variáveis para gerenciamento de banco de dados
    private bool mostrarGerenciador = false;
    private List<ProgramacaoAvancada.Models.Universo> universosSalvos = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var w = await JS.InvokeAsync<int>("eval", "document.querySelector('.simulation-area').clientWidth");
            var h = await JS.InvokeAsync<int>("eval", "document.querySelector('.simulation-area').clientHeight");

            Simulacao.CanvasWidth = w;
            Simulacao.CanvasHeight = h;

            loop = new System.Timers.Timer(16);
            loop.Elapsed += async (_, __) =>
            {
                Simulacao.Atualizar(deltaTime);
                await InvokeAsync(StateHasChanged);
            };
            loop.AutoReset = true;
            loop.Start();
        }
    }

    void Iniciar()
    {
        Simulacao.Iniciar();
        mensagem = "🚀 Simulação iniciada!";
        StateHasChanged();
    }

    void Parar()
    {
        Simulacao.Parar();
        mensagem = "⏸️ Simulação pausada";
        StateHasChanged();
    }

    void Resetar()
    {
        Simulacao.NumCorpos = Math.Max(1, Simulacao.NumCorpos);
        Simulacao.Resetar();
        mensagem = $"🔄 Resetado com {Simulacao.NumCorpos} corpos";
        StateHasChanged();
    }

    async Task Salvar()
    {
        try
        {
            string conteudo = Simulacao.GerarConteudoArquivo(Simulacao.Corpos, Simulacao.Iteracoes, deltaTime);
            await JS.InvokeVoidAsync("baixarArquivo", "estado_simulacao.txt", conteudo);
            mensagem = "✅ Arquivo TXT salvo com sucesso!";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao salvar TXT: {ex.Message}";
            StateHasChanged();
        }
    }

    // ✅ NOVOS MÉTODOS PARA BANCO DE DADOS

    private async Task SalvarNoBanco()
    {
        try
        {
            var id = await Simulacao.SalvarUniversoAtualAsync();
            if (id > 0)
            {
                mensagem = $"✅ Universo salvo no banco (ID: {id})";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao salvar no banco: {ex.Message}";
            StateHasChanged();
        }
    }

    private void ToggleGerenciarUniversos()
    {
        mostrarGerenciador = !mostrarGerenciador;
        if (mostrarGerenciador)
        {
            _ = CarregarListaUniversos(); // Carrega a lista quando abre o modal
        }
        StateHasChanged();
    }

    private async Task CarregarListaUniversos()
    {
        try
        {
            universosSalvos = await Simulacao.ObterUniversosSalvosAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao carregar lista: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task CarregarUniverso(int id)
    {
        try
        {
            if (await Simulacao.CarregarUniversoAsync(id))
            {
                mensagem = $"🌌 Universo #{id} carregado!";
                mostrarGerenciador = false; // Fecha o modal após carregar
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao carregar universo: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task AtualizarUniverso(int id)
    {
        try
        {
            if (await Simulacao.AtualizarUniversoAtualAsync(id))
            {
                mensagem = $"✏️ Universo #{id} atualizado!";
                await CarregarListaUniversos(); // Atualiza a lista
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao atualizar universo: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task DeletarUniverso(int id)
    {
        try
        {
            if (await Simulacao.DeletarUniversoAsync(id))
            {
                mensagem = $"🗑️ Universo #{id} deletado!";
                await CarregarListaUniversos(); // Atualiza a lista
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao deletar universo: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task CriarNovoUniverso()
    {
        try
        {
            var novoUniverso = await Simulacao.CriarNovoUniversoNoBancoAsync("Novo Universo Aleatório", 10);
            mensagem = $"🌟 Novo universo criado (ID: {novoUniverso.Id})";
            await CarregarListaUniversos(); // Atualiza a lista
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao criar universo: {ex.Message}";
            StateHasChanged();
        }
    }

    async Task OnFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var reader = new StreamReader(file.OpenReadStream());
            var conteudo = await reader.ReadToEndAsync();
            Simulacao.CarregarDeTxt(conteudo);
            mensagem = $"📂 Arquivo '{file.Name}' carregado!";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao carregar: {ex.Message}";
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        loop?.Stop();
        loop?.Dispose();
    }
}