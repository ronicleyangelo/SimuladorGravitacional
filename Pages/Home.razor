@page "/swagger"
@using ProgramacaoAvancada.Models
@inject ProgramacaoAvancada.Services.SimuladorService Simulacao
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Simulador Gravitacional 2D</PageTitle>

<div class="sim-container @(Simulacao.Rodando ? "simulacao-ativa" : "")">
    <!-- Área principal da simulação -->
    <div class="simulation-area">
        <div class="canvas-wrap">
            <svg @ref="svgElement" width="@Simulacao.CanvasWidth" height="@Simulacao.CanvasHeight"
                style="background-color: transparent;">
                @foreach (var corpo in Simulacao.Corpos)
                {
                    <circle cx="@corpo.PosX.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                        cy="@corpo.PosY.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                        r="@corpo.Raio.ToString(System.Globalization.CultureInfo.InvariantCulture)" fill="@corpo.Cor"
                        opacity="0.9" filter="url(#glow)" />
                }

                <text x="10" y="20" fill="#a0a0ff" font-size="12px">
                    Corpos: @Simulacao.Corpos.Count | Iterações: @Simulacao.Iteracoes | Colisões: @Simulacao.Colisoes
                </text>

                <!-- Efeito de glow para os corpos -->
                <defs>
                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur" />
                        <feMerge>
                            <feMergeNode in="coloredBlur" />
                            <feMergeNode in="SourceGraphic" />
                        </feMerge>
                    </filter>
                </defs>
            </svg>
        </div>

        <!-- Estatísticas em tempo real -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-value">@Simulacao.Corpos.Count</span>
                <span class="stat-label">Corpos</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">@Simulacao.Iteracoes</span>
                <span class="stat-label">Iterações</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">@Simulacao.Colisoes</span>
                <span class="stat-label">Colisões</span>
            </div>
            <div class="stat-item">
                <span class="stat-value status-indicator @(Simulacao.Rodando ? "status-ativa" : "status-pausada")">
                    @(Simulacao.Rodando ? "● Ativa" : "● Pausada")
                </span>
                <span class="stat-label">Status</span>
            </div>
        </div>
    </div>

    <!-- Painel lateral moderno -->
    <div class="side-panel">
        <div class="panel-header">
            <h1>🌌 Simulador Gravitacional</h1>
            <p>Controle a simulação em tempo real</p>
        </div>

        <div class="controls-container">
            <!-- Controles na parte superior -->
            <div class="controls">
                <div class="control-group">
                    <label for="numCorpos">🎯 Quantidade de Corpos</label>
                    <input type="number" id="numCorpos" @bind="Simulacao.NumCorpos" @bind:event="oninput"
                        min="1" max="50" class="num-input" />
                    <small style="color: #a0a0ff; font-size: 0.8rem;">
                        @(Simulacao.Corpos.Count != Simulacao.NumCorpos ? "Clique em Iniciar para aplicar" : "Quantidade aplicada")
                    </small>
                </div>

                <!-- ✅ Controles de Banco de Dados -->
                <div class="control-group">
                    <label for="nomeSimulacao">💾 Nome da Simulação</label>
                    <input type="text" id="nomeSimulacao" @bind="nomeSimulacao" placeholder="Digite um nome..." 
                           class="text-input" />
                </div>

                <div class="button-group">
                    <button @onclick="Iniciar" disabled="@Simulacao.Rodando" class="btn btn-start">
                        <span>▶️</span> Iniciar
                    </button>
                    <button @onclick="Parar" disabled="@(!Simulacao.Rodando)" class="btn btn-stop">
                        <span>⏸️</span> Parar
                    </button>
                    <button @onclick="Resetar" class="btn btn-reset">
                        <span>🔄</span> Resetar
                    </button>
                </div>

                <div class="button-group">
                    <!-- ✅ BOTÕES DE BANCO DE DADOS -->
                    <button @onclick="SalvarNoBanco" disabled="@string.IsNullOrEmpty(nomeSimulacao)" 
                            class="btn btn-save-db" title="Salvar no banco de dados">
                        <span>💾</span> Salvar no BD
                    </button>
                    <button @onclick="ListarSimulacoes" class="btn btn-list-db" title="Listar simulações salvas">
                        <span>📋</span> Listar Simulações
                    </button>
                    <button @onclick="LimparEventos" class="btn btn-clear" title="Limpar log de eventos">
                        <span>🧹</span> Limpar Log
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(mensagem))
            {
                <div class="mensagem @(mensagem.Contains("❌") ? "mensagem-erro" : "mensagem-sucesso")">
                    @mensagem
                </div>
            }

            <!-- ✅ SEÇÃO: Lista de Simulações Salvas -->
            @if (mostrarListaSimulacoes)
            {
                <div class="simulacoes-salvas">
                    <h3>💾 Simulações Salvas</h3>
                    
                    @if (simulacoesSalvas.Any())
                    {
                        <div class="lista-simulacoes">
                            @foreach (var simulacao in simulacoesSalvas)
                            {
                                <div class="item-simulacao">
                                    <div class="simulacao-info">
                                        <strong>@simulacao.Nome</strong>
                                        <small>ID: @simulacao.Id | Corpos: @simulacao.QuantidadeCorpos</small>
                                        <small>Iterações: @simulacao.NumeroIteracoes | Colisões: @simulacao.NumeroColisoes</small>
                                        <small>Salvo em: @simulacao.DataCriacao.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <div class="simulacao-actions">
                                        <button @onclick="() => CarregarSimulacao(simulacao.Id)" 
                                                class="btn-small btn-load" title="Carregar esta simulação">
                                            🔄 Carregar
                                        </button>
                                        <button @onclick="() => DeletarSimulacao(simulacao.Id, simulacao.Nome)" 
                                                class="btn-small btn-delete" title="Excluir esta simulação">
                                            🗑️ Excluir
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="sem-simulacoes">
                            <p>📭 Nenhuma simulação salva no banco</p>
                            <small>Salve uma simulação usando o botão "Salvar no BD"</small>
                        </div>
                    }
                    
                    <button @onclick="FecharLista" class="btn btn-close">
                        <span>❌</span> Fechar Lista
                    </button>
                </div>
            }

            <!-- Event-log -->
            <div class="event-log">
                <div class="event-log-header">
                    <h3>📜 Log de Eventos</h3>
                    <span class="event-count">@Simulacao.Eventos.Count eventos</span>
                </div>
                <div class="event-list">
                    @if (Simulacao.Eventos.Any())
                    {
                        @foreach (var evento in Simulacao.Eventos)
                        {
                            <div class="event-item">@evento</div>
                        }
                    }
                    else
                    {
                        <div class="event-item" style="text-align: center; opacity: 0.7; font-style: italic;">
                            ⏳ Aguardando eventos da simulação...
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ElementReference svgElement;
    private System.Timers.Timer? loop;
    private string mensagem = string.Empty;
    private string nomeSimulacao = string.Empty;
    private bool mostrarListaSimulacoes = false;
    private List<SimulacaoSnapshot> simulacoesSalvas = new();
    private const double deltaTime = 0.016;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var w = await JS.InvokeAsync<int>("eval", "document.querySelector('.simulation-area').clientWidth");
            var h = await JS.InvokeAsync<int>("eval", "document.querySelector('.simulation-area').clientHeight");

            Simulacao.CanvasWidth = w;
            Simulacao.CanvasHeight = h;

            loop = new System.Timers.Timer(16);
            loop.Elapsed += async (_, __) =>
            {
                Simulacao.Atualizar(deltaTime);
                await InvokeAsync(StateHasChanged);
            };
            loop.AutoReset = true;
            loop.Start();
        }
    }

    void Iniciar()
    {
        Simulacao.Iniciar();
        mensagem = "🚀 Simulação iniciada!";
        StateHasChanged();
    }

    void Parar()
    {
        Simulacao.Parar();
        mensagem = "⏸️ Simulação pausada";
        StateHasChanged();
    }

    void Resetar()
    {
        Simulacao.NumCorpos = Math.Max(1, Simulacao.NumCorpos);
        Simulacao.Resetar();
        mensagem = $"🔄 Resetado com {Simulacao.NumCorpos} corpos";
        StateHasChanged();
    }

    // ✅ MÉTODOS DE BANCO DE DADOS

    async Task SalvarNoBanco()
    {
        try
        {
            if (string.IsNullOrEmpty(nomeSimulacao))
            {
                mensagem = "❌ Digite um nome para a simulação";
                StateHasChanged();
                return;
            }

            bool sucesso = await Simulacao.SalvarNoBancoAsync(nomeSimulacao);
            if (sucesso)
            {
                mensagem = $"✅ Simulação '{nomeSimulacao}' salva no banco!";
                nomeSimulacao = ""; // Limpa o campo
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao salvar no banco: {ex.Message}";
            StateHasChanged();
        }
    }

    async Task ListarSimulacoes()
    {
        try
        {
            simulacoesSalvas = await Simulacao.ListarSimulacoesSalvasAsync();
            mostrarListaSimulacoes = true;
            mensagem = simulacoesSalvas.Any() 
                ? $"📋 {simulacoesSalvas.Count} simulações encontradas" 
                : "📭 Nenhuma simulação encontrada";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao carregar lista: {ex.Message}";
            StateHasChanged();
        }
    }

    async Task CarregarSimulacao(int id)
    {
        try
        {
            bool sucesso = await Simulacao.CarregarDoBancoAsync(id);
            if (sucesso)
            {
                mensagem = "✅ Simulação carregada com sucesso!";
                mostrarListaSimulacoes = false;
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao carregar simulação: {ex.Message}";
            StateHasChanged();
        }
    }

    async Task DeletarSimulacao(int id, string nome)
    {
        try
        {
            bool confirmado = await JS.InvokeAsync<bool>("confirm", $"Tem certeza que deseja excluir a simulação '{nome}'?");
            if (!confirmado) return;

            bool sucesso = await Simulacao.DeletarSimulacaoAsync(id, nome);
            if (sucesso)
            {
                // Atualiza a lista após exclusão
                simulacoesSalvas = simulacoesSalvas.Where(s => s.Id != id).ToList();
                mensagem = $"✅ Simulação '{nome}' excluída!";
                
                // Se não há mais simulações, fecha a lista
                if (!simulacoesSalvas.Any())
                {
                    mostrarListaSimulacoes = false;
                }
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensagem = $"❌ Erro ao excluir: {ex.Message}";
            StateHasChanged();
        }
    }

    void FecharLista()
    {
        mostrarListaSimulacoes = false;
        StateHasChanged();
    }

    void LimparEventos()
    {
        Simulacao.LimparEventos();
        mensagem = "🧹 Log de eventos limpo";
        StateHasChanged();
    }

    public void Dispose()
    {
        loop?.Stop();
        loop?.Dispose();
    }
}